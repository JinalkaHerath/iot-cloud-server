<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #e2e8f0;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f56565;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #48bb78;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .widget-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #4a5568;
        }

        .widget-icon {
            width: 24px;
            height: 24px;
            fill: #667eea;
        }

        .metric-value {
            font-size: 3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .metric-unit {
            font-size: 1.1em;
            color: #718096;
            margin-left: 5px;
        }

        .metric-change {
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .metric-change.positive {
            background: #c6f6d5;
            color: #22543d;
        }

        .metric-change.negative {
            background: #fed7d7;
            color: #822727;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            transition: background 0.3s ease;
        }

        .control-item:hover {
            background: #edf2f7;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #cbd5e0;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .switch.active {
            background: #48bb78;
        }

        .switch-handle {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .switch.active .switch-handle {
            transform: translateX(30px);
        }

        .slider-container {
            width: 100%;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .device-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .device-card.online {
            border-color: #48bb78;
        }

        .device-card.offline {
            border-color: #f56565;
            opacity: 0.7;
        }

        .device-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto 10px;
        }

        .device-status.online {
            background: #48bb78;
        }

        .device-status.offline {
            background: #f56565;
        }

        .alert-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .alert-item:hover {
            background: #f7fafc;
        }

        .alert-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .alert-warning {
            background: #ed8936;
        }

        .alert-error {
            background: #f56565;
        }

        .alert-info {
            background: #4299e1;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .button.danger {
            background: #f56565;
        }

        .button.danger:hover {
            background: #e53e3e;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>IoT Control Dashboard</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="connection-status"></div>
                    <span id="connection-text">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>Devices: <strong id="device-count">0</strong></span>
                </div>
                <div class="status-item">
                    <span>Last Update: <strong id="last-update">Never</strong></span>
                </div>
                <div class="status-item">
                    <span>Server: <strong>Vercel Cloud</strong></span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Temperature Widget -->
            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title">Temperature</span>
                    <svg class="widget-icon" viewBox="0 0 24 24">
                        <path d="M12 2c1.1 0 2 .9 2 2v8.5c1.7 1.2 2.5 3.1 2 5.1-.6 2.3-2.9 3.8-5.2 3.4-2.3-.4-4.1-2.4-4.1-4.9 0-1.1.4-2.1 1.1-2.9L8 4c0-1.1.9-2 2-2h2z"/>
                    </svg>
                </div>
                <div class="metric-value">
                    <span id="temperature">--</span>
                    <span class="metric-unit">°C</span>
                </div>
                <div class="metric-change positive" id="temp-change">Waiting for data...</div>
            </div>

            <!-- Humidity Widget -->
            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title">Humidity</span>
                    <svg class="widget-icon" viewBox="0 0 24 24">
                        <path d="M12 2l-4 8c-1.1 2.2 0 4.8 2.2 5.9 2.2 1.1 4.8 0 5.9-2.2.5-1 .5-2.2 0-3.2L12 2z"/>
                    </svg>
                </div>
                <div class="metric-value">
                    <span id="humidity">--</span>
                    <span class="metric-unit">%</span>
                </div>
                <div class="metric-change negative" id="humidity-change">Waiting for data...</div>
            </div>

            <!-- Device Controls -->
            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title">Device Controls</span>
                    <svg class="widget-icon" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </div>
                <div class="control-panel">
                    <div class="control-item">
                        <span>LED Strip</span>
                        <div class="switch" onclick="toggleSwitch(this, 'led')">
                            <div class="switch-handle"></div>
                        </div>
                    </div>
                    <div class="control-item">
                        <span>Water Pump</span>
                        <div class="switch" onclick="toggleSwitch(this, 'pump')">
                            <div class="switch-handle"></div>
                        </div>
                    </div>
                    <div class="control-item">
                        <span>Fan Speed</span>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="45" class="slider" id="fan-speed" oninput="updateFanSpeed(this.value)">
                            <div style="text-align: center; margin-top: 5px; font-weight: 500;" id="fan-display">45%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Chart -->
            <div class="widget" style="grid-column: span 2;">
                <div class="widget-header">
                    <span class="widget-title">Sensor Data (Real-time)</span>
                    <div>
                        <button class="button" onclick="toggleDataStream()">
                            <span id="stream-btn-text">Pause</span>
                        </button>
                        <button class="button" onclick="clearChart()">Clear</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>

            <!-- Power Consumption -->
            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title">Power Usage</span>
                    <svg class="widget-icon" viewBox="0 0 24 24">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                    </svg>
                </div>
                <div class="metric-value">
                    <span id="power">--</span>
                    <span class="metric-unit">W</span>
                </div>
                <div class="metric-change positive">Waiting for data...</div>
                <div style="margin-top: 15px;">
                    <div style="font-size: 0.9em; color: #718096; margin-bottom: 5px;">Today: $--</div>
                    <div style="font-size: 0.9em; color: #718096;">This month: $--</div>
                </div>
            </div>

            <!-- Device Status Grid -->
            <div class="widget">
                <div class="widget-header">
                    <span class="widget-title">Connected Devices</span>
                    <span style="font-size: 0.9em; color: #718096;" id="online-devices">0/0 online</span>
                </div>
                <div class="device-grid">
                    <div class="device-card offline" onclick="toggleDevice(this)">
                        <div class="device-status offline"></div>
                        <div style="font-weight: 500;">Device 001</div>
                        <div style="font-size: 0.8em; color: #718096;">Kitchen</div>
                    </div>
                    <div class="device-card offline" onclick="toggleDevice(this)">
                        <div class="device-status offline"></div>
                        <div style="font-weight: 500;">Device 002</div>
                        <div style="font-size: 0.8em; color: #718096;">Living Room</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts Panel -->
        <div class="alert-panel">
            <h3 style="margin-bottom: 20px; color: #4a5568;">System Log</h3>
            <div id="log-container">
                <div class="alert-item">
                    <div class="alert-icon alert-info">i</div>
                    <div>
                        <div style="font-weight: 600;">Dashboard Started</div>
                        <div style="font-size: 0.9em; color: #718096;">Attempting to connect to cloud server...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let chart;
        let isStreaming = true;
        let cloudWebSocket;
        let deviceStates = {
            led: false,
            pump: false,
            fanSpeed: 45
        };

        // YOUR VERCEL SERVER URL - REPLACE WITH YOUR ACTUAL URL
        const CLOUD_SERVER_URL = 'iot-cloud-server-43h806lll-jinalka-s-projects.vercel.app';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            connectToCloudServer();
            updateLastUpdateTime();
            
            // Animate widgets on load
            const widgets = document.querySelectorAll('.widget');
            widgets.forEach((widget, index) => {
                widget.style.opacity = '0';
                widget.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    widget.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    widget.style.opacity = '1';
                    widget.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // Connect to cloud server
        function connectToCloudServer() {
            const serverUrl = `wss://${CLOUD_SERVER_URL}/?type=web`;
            addLogMessage('info', 'Connecting to Cloud Server', 'Attempting WebSocket connection...');
            
            cloudWebSocket = new WebSocket(serverUrl);
            
            cloudWebSocket.onopen = function() {
                console.log('🌐 Connected to cloud server');
                document.getElementById('connection-status').classList.add('connected');
                document.getElementById('connection-text').textContent = 'Cloud Connected';
                addLogMessage('info', 'Connected to Cloud', 'Successfully connected to IoT cloud server');
            };
            
            cloudWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('📨 Received from cloud:', data);
                
                if (data.type === 'sensorUpdate') {
                    updateSensorDisplays(data.data);
                    addLogMessage('info', 'Data Received', `Updated from ${data.deviceId}`);
                } else if (data.type === 'deviceDisconnected') {
                    addLogMessage('warning', 'Device Offline', `${data.deviceId} disconnected`);
                } else if (data.type === 'initialData') {
                    updateDeviceList(data.devices);
                    updateSensorDisplays(data.sensors);
                }
            };
            
            cloudWebSocket.onclose = function() {
                console.log('❌ Disconnected from cloud server');
                document.getElementById('connection-status').classList.remove('connected');
                document.getElementById('connection-text').textContent = 'Reconnecting...';
                addLogMessage('error', 'Connection Lost', 'Reconnecting in 5 seconds...');
                
                // Reconnect after 5 seconds
                setTimeout(connectToCloudServer, 5000);
            };
            
            cloudWebSocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                addLogMessage('error', 'Connection Error', 'Failed to connect to cloud server');
            };
        }

        // Send command to cloud server
        function sendCommandToCloud(deviceId, command, value) {
            if (cloudWebSocket && cloudWebSocket.readyState === WebSocket.OPEN) {
                const commandData = {
                    deviceId: deviceId,
                    command: command,
                    value: value,
                    timestamp: new Date().toISOString()
                };
                
                // Send to cloud server via REST API
                fetch(`https://${CLOUD_SERVER_URL}/api/devices/${deviceId}/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commandData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Command sent:', data);
                    if (data.success) {
                        addLogMessage('info', 'Command Sent', `${command}: ${value}`);
                    } else {
                        addLogMessage('error', 'Command Failed', data.error);
                    }
                })
                .catch(error => {
                    console.error('❌ Error sending command:', error);
                    addLogMessage('error', 'Network Error', 'Failed to send command');
                });
            } else {
                addLogMessage('error', 'Not Connected', 'Cannot send command - not connected to cloud');
            }
        }

        // Update sensor displays
        function updateSensorDisplays(data) {
            if (data.temperature !== undefined) {
                document.getElementById('temperature').textContent = data.temperature.toFixed(1);
                document.getElementById('temp-change').textContent = 'Live data from cloud';
            }
            if (data.humidity !== undefined) {
                document.getElementById('humidity').textContent = Math.round(data.humidity);
                document.getElementById('humidity-change').textContent = 'Live data from cloud';
            }
            if (data.power !== undefined) {
                document.getElementById('power').textContent = Math.round(data.power);
            }
            updateLastUpdateTime();
            
            // Update chart if data is available
            if (data.temperature && data.humidity) {
                updateChart(data.temperature, data.humidity);
            }
        }

        // Update device list
        function updateDeviceList(devices) {
            const onlineCount = devices.filter(d => d.online).length;
            document.getElementById('online-devices').textContent = `${onlineCount}/${devices.length} online`;
            document.getElementById('device-count').textContent = devices.length;
        }

        // Add log message
        function addLogMessage(type, title, message) {
            const logContainer = document.getElementById('log-container');
            const alertClass = type === 'error' ? 'alert-error' : type === 'warning' ? 'alert-warning' : 'alert-info';
            const icon = type === 'error' ? '×' : type === 'warning' ? '!' : 'i';
            
            const logItem = document.createElement('div');
            logItem.className = 'alert-item';
            logItem.innerHTML = `
                <div class="alert-icon ${alertClass}">${icon}</div>
                <div>
                    <div style="font-weight: 600;">${title}</div>
                    <div style="font-size: 0.9em; color: #718096;">${message} - ${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            // Add to top
            logContainer.insertBefore(logItem, logContainer.firstChild);
            
            // Keep only last 5 messages
            while (logContainer.children.length > 5) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Initialize Chart.js
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Humidity (%)',
                        data: [],
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });
        }

        // Update chart with new data
        function updateChart(temperature, humidity) {
            if (!isStreaming) return;
            
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            chart.data.labels.push(timeLabel);
            chart.data.datasets[0].data.push(temperature);
            chart.data.datasets[1].data.push(humidity);
            
            // Keep only last 20 data points
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            
            chart.update('none');
        }

        // Toggle switch function - sends to cloud
        function toggleSwitch(element, device) {
            element.classList.toggle('active');
            const newState = element.classList.contains('active');
            deviceStates[device] = newState;
            
            // Send command to cloud server
            sendCommandToCloud('device_001', device, newState);
        }

        // Update fan speed - sends to cloud
        function updateFanSpeed(value) {
            deviceStates.fanSpeed = value;
            document.getElementById('fan-display').textContent = value + '%';
            
            // Send command to cloud server
            sendCommandToCloud('device_001', 'fanSpeed', parseInt(value));
        }

        // Toggle data streaming
        function toggleDataStream() {
            isStreaming = !isStreaming;
            const btn = document.getElementById('stream-btn-text');
            btn.textContent = isStreaming ? 'Pause' : 'Resume';
        }

        // Clear chart data
        function clearChart() {
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            chart.update();
        }

        // Toggle device status (simulation)
        function toggleDevice(element) {
            const isOnline = element.classList.contains('online');
            if (isOnline) {
                element.classList.remove('online');
                element.classList.add('offline');
                element.querySelector('.device-status').classList.remove('online');
                element.querySelector('.device-status').classList.add('offline');
            } else {
                element.classList.remove('offline');
                element.classList.add('online');
                element.querySelector('.device-status').classList.remove('offline');
                element.querySelector('.device-status').classList.add('online');
            }
            updateOnlineDeviceCount();
        }

        // Update online device count
        function updateOnlineDeviceCount() {
            const onlineDevices = document.querySelectorAll('.device-card.online').length;
            const totalDevices = document.querySelectorAll('.device-card').length;
            document.getElementById('online-devices').textContent = `${onlineDevices}/${totalDevices} online`;
            document.getElementById('device-count').textContent = totalDevices;
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
    </script>
</body>
</html>